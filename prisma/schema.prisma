generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  name          String
  email         String         @unique
  passwordHash  String
  role          String         @default("USER")
  createdAt     DateTime       @default(now()) @db.Timestamptz(6)
  enrollments   Enrollment[]
  refreshTokens RefreshToken[]

  @@map("users")
}

model Course {
  id          String       @id @default(uuid())
  title       String
  category    String
  description String
  objectives  String
  hours       Int
  price       Float
  level       String
  thumbnail   String // مسار الصورة المحلية (مثال: /uploads/courses/course-id.jpg)
  meetingLink String? // رابط Teams أو Meet للدورة
  createdAt   DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime     @updatedAt @db.Timestamptz(6)
  enrollments Enrollment[]
  lessons     Lesson[] // دروس الدورة

  @@map("courses")
}

model Enrollment {
  id              String   @id @default(uuid())
  userId          String
  courseId        String
  status          String
  progressPercent Int
  certificateId   String?
  certificateUrl  String?
  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @db.Timestamptz(6)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("enrollments")
}

// جدول لتخزين Refresh Tokens في قاعدة البيانات
model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime @db.Timestamptz(6)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refreshtokens")
}

// جدول لتخزين Rate Limiting في قاعدة البيانات
model RateLimit {
  id        String   @id @default(uuid())
  ip        String   @unique
  count     Int      @default(1)
  resetAt   DateTime @db.Timestamptz(6)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  @@index([resetAt])
  @@map("ratelimits")
}

// جدول الدروس (Lessons)
model Lesson {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  description String
  content     String // محتوى الدرس (HTML أو Markdown)
  order       Int // ترتيب الدرس في الدورة
  duration    Int? // مدة الدرس بالدقائق
  videoUrl    String? // رابط فيديو الدرس (اختياري)
  resources   String? // موارد إضافية (JSON)
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([courseId, order])
  @@map("lessons")
}

// جدول إعدادات النظام
model SystemSettings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  type      String   @default("string") // string, number, boolean, json
  category  String   @default("general") // general, email, payment, etc.
  updatedAt DateTime @updatedAt @db.Timestamptz(6)
  updatedBy String?  // ID المستخدم الذي قام بالتحديث

  @@index([category])
  @@map("systemsettings")
}
