generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  email         String         @unique
  passwordHash  String
  role          String         @default("USER")
  createdAt     DateTime       @default(now())
  enrollments   Enrollment[]
  refreshTokens RefreshToken[]

  @@map("users")
}

model Course {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  category    String
  description String
  objectives  String
  hours       Int
  price       Float
  level       String
  thumbnail   String // مسار الصورة المحلية (مثال: /uploads/courses/course-id.jpg)
  meetingLink String? // رابط Teams أو Meet للدورة
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  enrollments Enrollment[]
  lessons     Lesson[] // دروس الدورة

  @@map("courses")
}

model Enrollment {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @db.ObjectId
  courseId        String   @db.ObjectId
  status          String
  progressPercent Int
  certificateId   String?
  certificateUrl  String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id])
  course          Course   @relation(fields: [courseId], references: [id])

  @@unique([userId, courseId])
  @@map("enrollments")
}

// جدول لتخزين Refresh Tokens في قاعدة البيانات
model RefreshToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refreshtokens")
}

// جدول لتخزين Rate Limiting في قاعدة البيانات
model RateLimit {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  ip        String
  count     Int      @default(1)
  resetAt   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ip])
  @@index([resetAt])
  @@map("ratelimits")
}

// جدول الدروس (Lessons)
model Lesson {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  courseId    String   @db.ObjectId
  title       String
  description String
  content     String // محتوى الدرس (HTML أو Markdown)
  order       Int // ترتيب الدرس في الدورة
  duration    Int? // مدة الدرس بالدقائق
  videoUrl    String? // رابط فيديو الدرس (اختياري)
  resources   String? // موارد إضافية (JSON)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([courseId, order])
  @@map("lessons")
}

// جدول إعدادات النظام
model SystemSettings {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique
  value     String
  type      String   @default("string") // string, number, boolean, json
  category  String   @default("general") // general, email, payment, etc.
  updatedAt DateTime @updatedAt
  updatedBy String?  @db.ObjectId // ID المستخدم الذي قام بالتحديث

  @@index([category])
  @@map("systemsettings")
}
